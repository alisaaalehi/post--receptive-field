<!DOCTYPE html>
<html>
<head>
<style>
body {
  padding: 0;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  color: rgba(0, 0, 0, 0.6);
  font-size: 13px;
}
[data-tip] {
	position:relative;

}
[data-tip]:before {
	content:'';
	/* hides the tooltip when not hovered */
	display:none;
	content:'';
	border-left: 5px solid transparent;
	border-right: 5px solid transparent;
	border-bottom: 5px solid #1a1a1a;	
	position:absolute;
	top:20px;
	right:20px;
	z-index:8;
	font-size:0;
	line-height:0;
	width:0;
	height:0;
}
[data-tip]:after {
	display:none;
	content:attr(data-tip);
	position:absolute;
	top:25px;
	right:0px;
	padding:5px 8px;
	background:#1a1a1a;
	color:#fff;
	z-index:9;
	font-size: 0.75em;
	height:18px;
	line-height:18px;
	-webkit-border-radius: 3px;
	-moz-border-radius: 3px;
	border-radius: 3px;
	white-space:nowrap;
	word-wrap:normal;
}
[data-tip]:hover:before,
[data-tip]:hover:after {
	display:block;
}
</style>
</head>
<body>

<img style="position: absolute; right: 0;" height="27" width="27" src="https://distill.pub/2018/feature-wise-transformations/images/pointer.svg" />

<svg id="svg" height="580" width="800">

  Sorry, your browser does not support inline SVG.
</svg>

<div style="position: absolute; top: 10px; left: 40px;">f<sub>0</sub></div>
<div style="position: absolute; top: 140px; left: 40px;">f<sub>1</sub></div>
<div style="position: absolute; top: 270px; left: 40px;">f<sub>2</sub></div>
<div style="position: absolute; top: 400px; left: 40px;">f<sub>3</sub></div>
<div style="position: absolute; top: 530px; left: 40px;">f<sub>4</sub></div>

<div style="position: absolute; top: 53px; right: 0px; text-align: right;">
<b>Convolution</b><br />
Kernel Size (k<sub>1</sub>): <span id="value_k1">1</span> <input id="slider_k1" type="range" style="width: 80px;" min="1" max="3" value="3"><br />
Padding (p<sub>1</sub>, q<sub>1</sub>): <span id="value_p1">0</span> <input id="slider_p1" type="range" style="width: 80px;" min="0" max="2" value="1"><br />
Stride (s<sub>1</sub>): <span id="value_s1">1</span> <input id="slider_s1" type="range" style="width: 80px;" min="1" max="2" value="2"><br />
<span id="value_error_1" style="display: none; color: red;">Invalid setup! Decrease kernel<br />size or increase padding.</span>
</div>

<div style="position: absolute; top: 183px; right: 0px; text-align: right;" data-tip="ReLUs only map features one-to-one.">
<b>ReLU</b><br />
Kernel Size (k<sub>2</sub>): <span id="value_k2">1</span> <input id="slider_k2" type="range" style="width: 80px; display: none;" min="1" max="3" value="1" disabled><br />
Padding (p<sub>2</sub>, q<sub>2</sub>): <span id="value_p2">0</span> <input id="slider_p2" type="range" style="width: 80px; display: none;" min="0" max="3" value="0" disabled><br />
Stride (s<sub>2</sub>): <span id="value_s2">1</span> <input id="slider_s2" type="range" style="width: 80px; display: none;" min="1" max="3" value="1" disabled><br />
</div>

<div style="position: absolute; top: 313px; right: 0px; text-align: right;">
<b>Convolution</b><br />
Kernel Size (k<sub>3</sub>): <span id="value_k3">1</span> <input id="slider_k3" type="range" style="width: 80px;" min="1" max="3" value="1"><br />
Padding (p<sub>3</sub>, q<sub>3</sub>): <span id="value_p3">0</span> <input id="slider_p3" type="range" style="width: 80px;" min="0" max="1" value="0"><br />
Stride (s<sub>3</sub>): <span id="value_s3">1</span> <input id="slider_s3" type="range" style="width: 80px;" min="1" max="2" value="1"><br />
<span id="value_error3" style="display: none; color: red;">Invalid setup! Decrease kernel<br />size or increase padding.</span>
</div>

<div style="position: absolute; top: 443px; right: 0px; text-align: right;">
<b>Max Pooling</b><br />
Kernel Size (k<sub>4</sub>): <span id="value_k4">1</span> <input id="slider_k4" type="range" style="width: 80px;" min="1" max="3" value="3"><br />
Padding (p<sub>4</sub>, q<sub>4</sub>): <span id="value_p4">0</span> <input id="slider_p4" type="range" style="width: 80px;" min="0" max="1" value="1"><br />
Stride (s<sub>4</sub>): <span id="value_s4">1</span> <input id="slider_s4" type="range" style="width: 80px;" min="1" max="2" value="2"><br />
<span id="value_error4" style="display: none; color: red;">Invalid setup! Decrease kernel<br />size or increase padding.</span>
</div>

<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript">
var svgEl = document.getElementById("svg");
var globals = {
  "box_width": 30,
  "box_height": 30,
  "box_inner_padding": 5,
  "row_space": 100,
  "perspective_shift": 18,
  "perspective_spacing": 4,
  "stroke_width": 1
};

DEFAULT_WIDTH = 13;
DEFAULT_INDENT = 4;

var redoRendering = function() {
  svgEl.innerHTML = "";
  renderRowFn(svgEl, 1, DEFAULT_WIDTH, DEFAULT_INDENT, globals);

  // k=kernel size, p=padding size, s=stride, w=feature width, i=indent
  var params = [
    {"k": -1, "p": -1, "s": -1, "w": DEFAULT_WIDTH, "i": DEFAULT_INDENT}
  ];

  for (var i = 1; i <= 4; i++) {
    var kernel_size = parseInt(document.getElementById("slider_k" + i).value);
    document.getElementById("value_k" + i).innerText = kernel_size;
    var padding = parseInt(document.getElementById("slider_p" + i).value);
    document.getElementById("value_p" + i).innerText = padding;
    var stride = parseInt(document.getElementById("slider_s" + i).value);
    document.getElementById("value_s" + i).innerText = stride;

    var input_fw = params[i-1]["w"];
    var padded_input_fw = input_fw + (2 * padding);
    var output_fw = Math.ceil((padded_input_fw-(kernel_size-1))/stride);
    var output_indent = Math.max(0, params[i-1]["i"] - Math.ceil((output_fw - input_fw)/2));
    
    params.push({"k": kernel_size, "p": padding, "s": stride, "w": output_fw, "i": output_indent});

    if (document.getElementById("value_error" + i)) {
      document.getElementById("value_error" + i).style.display = output_fw < 1 ? "block" : "none";
    }

    flowStack = [];
    for (var j=0, k=0; kernel_size+k-1 < padded_input_fw; k += stride, j++) {
      //renderFlowFn = function (el, row, width1, width2, offset1, offset2, globals) {
      renderFlowFn(svgEl, i, kernel_size, 1, params[i-1]["i"]-padding+k, output_indent+j, globals, undefined, i==2);
    } 
    renderRowFn(svgEl, i+1, output_fw, output_indent, globals);
  }

  var featureNodes = document.querySelectorAll(".feature");
  for (var i=0; i < featureNodes.length; i++) {
    featureNodes[i].addEventListener("mouseenter", renderSingleFlowStack);
  }
};

var nodes = document.querySelectorAll("input");
for (var i = 0; i < nodes.length; i++) {
  nodes[i].setAttribute("oninput", "redoRendering();");
}

redoRendering();

</script>

</body>
</html>
